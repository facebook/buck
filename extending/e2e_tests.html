<!doctype html><html xmlns="http://www.w3.org/1999/xhtml"><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns#"><script>var loc = new String(window.location); if (loc.indexOf('facebook.github.io/buck') != -1) {window.location.replace(loc.replace('facebook.github.io/buck', 'buck.build'));}</script><!-- Facebook Pixel Code --><script>!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,document,'script','//connect.facebook.net/en_US/fbevents.js'); fbq('init', '1637165926500152'); fbq('track', 'PageView');</script><noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=1637165926500152&ev=PageView&noscript=1" /></noscript><!-- End Facebook Pixel Code --><title>Buck: Building End to End tests for Buck</title><link type="image/png" rel="shortcut icon" href="/static/favicon.png" /><meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" /><meta http-equiv="content-type" content="text/html;charset=utf-8"><link type="text/css" rel="stylesheet" href="/google-code-prettify/prettify.css" ><link type="text/css" rel="stylesheet" href="/static/buck.css"><link type="text/css" rel="stylesheet" href="/static/search.css"><link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css" /><meta property="og:locale" content="en_US"><meta property="og:title" content="Building End to End tests for Buck"><meta property="og:site_name" content="Buck: a build tool"><meta property="og:image" content="http://buck.build/static/og.png"><meta property="og:type" content="article"><meta property="og:description" content="A guide to adding E2E tests for Buck"><meta property="fb:admins" content="584556688222168"><script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-44373548-18', 'auto');
    ga('send', 'pageview');
  </script></head><body><div id="fb-root"></div><script>(function(d, s, id) {var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=584556688222168"; fjs.parentNode.insertBefore(js, fjs);}(document, 'script', 'facebook-jssdk'));</script><header class='topbar'><nav class='width'><a href='http://buck.build/'><h1>Buck</h1></a><ul class='menu'><li class="algolia-search-wrapper"><input id="algolia-doc-search" type="search" placeholder="Search docs..." /></li><li><a href='/setup/getting_started.html'>Docs</a><li><a href='https://github.com/facebook/buck/issues'>Issues</a><li><a href='https://github.com/facebook/buck'>GitHub</a></ul></nav></header><section class='content'><div class='width'><article id="content"><h1>Building End to End tests for Buck</h1><div class="overview"><p>Buck has a framework that allows easy creation of End to End testing of Buck's functionality. It includes features like:</p><ul><li>Easy separation of tests based on permutations of environment variables, commands options, .buckconfig values, etc.</li><li>Standard JUnit Test Runner annotation support (<code>@After</code>, <code>@Before</code>,<code>@Rule</code>, etc)</li><li>Workspace that gives interface in to it to run buck commands, and perform actions</li><li>Easy access to running the programs built by a "build" command</li><li>Pre-made templates built for general use-cases</li></ul><p>In this, we will show how to create a basic test that builds a very simple CXX project, and go over how this test could be extended further for more complicated testing scenarios.</p><h3>The Basic Build</h3><pre class="prettyprint lang-basic">
// imports and package name omitted

@RunWith(EndToEndRunner.class)
public class CxxEndToEndTest {

  private static final String successTarget =
    "//simple_successful_helloworld:simple_successful_helloworld";

  @Environment
  public static EndToEndEnvironment baseEnvironment() {
    return new EndToEndEnvironment()
        .addTemplates("cxx")
        .withCommand("build")
        .withTargets(successTarget);
  }

  /** Determines that buck successfully outputs proper programs */
  @Test
  public void shouldBuild(EndToEndTestDescriptor test, EndToEndWorkspace workspace)
      throws Exception {
    ProcessResult result = workspace.runBuckCommand(test);
    result.assertSuccess("Did not successfully build");
  }
}
</pre><p>This will run two individual tests, that spawn independent workspaces, one using buckd and one not. They will both build the <code>simple_sucessful_helloworld</code> target and verify that this build was successful. Let's go over these things step by step.</p><h3>Calling the Runner</h3><pre class="prettyprint lang-basic">
@RunWith(EndToEndRunner.class)
public class CxxEndToEndTest {
</pre><p>This simply declares that you are using the EndToEndRunner</p><h3>@Environment</h3><pre class="prettyprint lang-basic">
private static final String successTarget =
      "//simple_successful_helloworld:simple_successful_helloworld";

@Environment
public static EndToEndEnvironment baseEnvironment() {
  return new EndToEndEnvironment()
      .addTemplates("cxx")
      .withCommand("build")
      .withTargets(successTarget);
}
</pre><p>The <strong>EndToEndEnvironment</strong> describes the configurations you want your tests to run in, they are found by the Runner using the <code>@Environment</code> annotation. Methods described by this annotation must be public static functions that return <strong>EndToEndEnvironment</strong> objects. These will create the workspace with the given permutations by default for all verification methods (unless you use <code>@EnvironmentFor</code>). In this test we define:</p><ul><li>To import the <a href="https://github.com/facebook/buck/tree/master/test/com/facebook/buck/testutil/endtoend/testdata/cxx"><code>cxx</code></a> template in to the workspace for all tests that use this environment</li><li>That the provided buck command will be a <code>build</code> command with the <code>successTarget</code> as its target</li></ul><p>In all, the <strong>EndToEndEnvironment</strong> supports:</p><h4>Templates</h4><p>Templates are pre-made project structures to be imported in to the Workspace created by the Runner for each test. These directories can be found in the <a href="https://github.com/facebook/buck/tree/master/test/com/facebook/buck/testutil/endtoend/testdata"><code>testdata</code></a> directory.</p><p>Any files with the extensions .fixture, .fixtureTestClass, or .fixtureTestClassVerificationMethodName will be copied over to the new directory without that extension (this is normally used for BUCK files), with the most specific fixture taking precedence.</p><pre class="prettyprint lang-basic">
...
    .addTemplates("mobile", "test_runners")
</pre><h4>Local Config Sets</h4><p>For each set added using <code>.addLocalConfigSet</code>, new permutations of tests will be created with this set of configurations as if they were set in a .buckconfig.local file. The method takes a Map, where the entries represent section - option - value as if in the configuration files.</p><p>By default, tests will be run with a a single empty set, but this will be replaced if any configuration set is added.</p><p>Some useful pre-made configuration sets can be reused by using the <strong>ConfigSetBuilder</strong>.</p><pre class="prettyprint lang-basic">
ConfigSetBuilder configSetBuilder = new ConfigSetBuilder()
...
    .addLocalConfigSet(configSetBuilder.build())
    .addLocalConfigSet(configSetBuilder.addSourceABIConfigSet().build());
</pre><h4>Variable Maps</h4><p>By default, the Runner will pass along any environment variables (<code>JAVA_HOME</code>, <code>ANDROID_SDK</code>, etc.) to the processes it creates. To override these, you would add that variable to a map.</p><p>For each map added using <code>.addVariableMap</code>, new permutations of tests will be created with this map.</p><p>By default, tests will be run with a a single empty set, but this will be replaced if any configuration set is added.</p><pre class="prettyprint lang-basic">
Map<String, String> variableOverride = new Hashmap<>();
variableOverride.put("ANDROID_SDK", "/opt/android_sdk");
...
    .addVariableMap(variableOverride)
</pre><h4>Buckd Status</h4><p>By default, we run end to end tests without creating a new buckd to run the commands against. If we want to, then we feed a different <strong>ToggleState</strong> in to the Environment, which defines if we want the test to run with buckd, without buckd, or to create two permutations with and without buckd respectively.</p><pre class="prettyprint lang-basic">
...
    .withBuckdToggled(ToggleState.ON_OFF)
</pre><h4>Command</h4><p>This is the command that will be sent to buck (i.e. <code>build</code>, <code>query</code>, etc.)</p><pre class="prettyprint lang-basic">
...
    .withCommand("build")
</pre><h4>Arguments</h4><p>These are the arguments to add to the command that will be sent to buck (i.e. flags)</p><pre class="prettyprint lang-basic">
...
    .withArguments("--show-output")
</pre><h4>Targets</h4><p>These are the build targets to run the buck commands against.</p><p><strong>Note:</strong> that these targets must be fully qualified, as the runner will automatically append flavors as appropriate for platform compatibility.</p><pre class="prettyprint lang-basic">
...
    .withTargets("//android:demo-app")
</pre><h3>@EnvironmentFor</h3><pre class="prettyprint lang-basic">
@EnvironmentFor(testNames = {"verificationMethodName"})
public static EndToEndEnvironment baseEnvironment() {
</pre><p>The <strong>@EnvironmentFor</strong> annotation marks environments specific to specified tests. These annotations must mark verification methods that exist in the given test class.</p><h3>@Test</h3><pre class="prettyprint lang-basic">
/** Determines that buck successfully outputs proper programs */
@Test
public void shouldBuildAndRun(EndToEndTestDescriptor test, EndToEndWorkspace workspace)
    throws Exception {
  ProcessResult result = workspace.runBuckCommand(test);
  result.assertSuccess("Did not successfully build");
}
</pre><p>The <strong>@Test</strong> annotation marks verification methods for the <strong>EndToEndRunner</strong>. The parameters it sends to each test is:</p><ul><li>The <strong>EndToEndTestDescriptor</strong> which contains information on the specific configuration the command was run on.</li><li>The <strong>EndToEndWorkspace</strong> which allows access to the workspace that has been prepared for the test to be ran. This workspace additionally provides convenience functions like the ability to launch non-blocking buck command processes, or running built non-mobile targets.</li></ul><p>In this test, we build using the ability to run a buck command directly from a <strong>TestDescriptor</strong>. We then verify the test successfully built using the given process result.</p><h3>Extending Templates</h3><p>If a template does not have something you need, it is preferred that you find a way for that template to work for you instead of creating a brand new one. If you do modify a template, please make sure that other tests using that template still work (this is automated in regular test runs).</p><p>There are a few ways you can extend templates:</p><ul><li><strong>Fixture files</strong>: as defined in the templates section. These are useful for cases where you want to modify existing files for specific test cases</li><li><strong>Adding new rules/dependencies</strong>: This is fairly self-explanatory, but if you see tricky corner cases not in the current templates for that build type, that's a good reason to add that case to the template. Additions are generally more welcome than modifications to the templates.</li>Please make sure to update the documentation for these templates when you do make any changes, which can be found in the given template's E2E test class. This documentation includes ascii charts of the dependency charts for these templates which should be maintained.<li><strong>Adding new templates</strong>: This approach should be used for when a type of project structure is not represented by an existing template, or if you imagine that the template can be added to many other templates quite easily (an example would be a template containing a set of external test runners). Please make sure that these new templates work on all applicable platforms (i.e. Mac, Windows, Linux, etc.)</li></ul></div></article><nav><h3>The Basics</h3><ul><li class=""><a href="/setup/getting_started.html">Getting Started</a></li><li class=""><a href="/about/overview.html">Key Concepts</a></li><li class=""><a href="/learning/tutorial.html">Tutorial</a></li><li class=""><a href="/setup/intellij_plugin_install.html">Installing the IntelliJ Plugin</a></li><li class=""><a href="/article/exopackage.html">Exopackage</a></li><li class=""><a href="/article/query_cheat_sheet.html">Buck Cheat Sheet</a></li></ul><h3>About</h3><ul><li class=""><a href="/concept/what_makes_buck_so_fast.html">What Makes Buck so Fast?</a></li><li class=""><a href="/about/showcase.html">Showcase</a></li><li class=""><a href="/concept/troubleshooting.html">Troubleshooting</a></li><li class=""><a href="/about/performance_tuning.html">Performance Tuning</a></li><li class=""><a href="/concept/faq.html">FAQ</a></li><li class=""><a href="/presentations/index.html">Learn More (Buck Presentations)</a></li></ul><h3>Concepts</h3><ul><li class=""><a href="/concept/build_rule.html">Build Rule</a></li><li class=""><a href="/concept/build_file.html">Build File</a></li><li class=""><a href="/concept/build_target.html">Build Target</a></li><li class=""><a href="/concept/build_target_pattern.html">Build Target Pattern</a></li><li class=""><a href="/concept/buckd.html">Buck Daemon (buckd)</a></li><li class=""><a href="/concept/visibility.html">Visibility</a></li><li class=""><a href="/concept/flavors.html">Flavors</a></li><li class=""><a href="/concept/http_cache_api.html">HTTP Cache API</a></li><li class=""><a href="/concept/rule_keys.html">Rule Keys</a></li><li class=""><a href="/concept/java_abis.html">Java ABIs</a></li><li class=""><a href="/concept/skylark.html">Skylark</a></li></ul><h3>Files and Directories</h3><ul><li class=""><a href="/files-and-dirs/buckconfig.html">.buckconfig</a></li><li class=""><a href="/files-and-dirs/buckjavaargs.html">.buckjavaargs</a></li><li class=""><a href="/files-and-dirs/buck-out.html">buck-out</a></li></ul><h3>Commands</h3><ul><li class=""><a href="/command/common_parameters.html">Common Parameters</a></li><li class=""><a href="/command/audit.html">buck audit</a></li><li class=""><a href="/command/build.html">buck build</a></li><li class=""><a href="/command/clean.html">buck clean</a></li><li class=""><a href="/command/doctor.html">buck doctor</a></li><li class=""><a href="/command/fetch.html">buck fetch</a></li><li class=""><a href="/command/fix.html">buck fix</a></li><li class=""><a href="/command/install.html">buck install</a></li><li class=""><a href="/command/kill.html">buck kill</a></li><li class=""><a href="/command/killall.html">buck killall</a></li><li class=""><a href="/command/project.html">buck project</a></li><li class=""><a href="/command/publish.html">buck publish</a></li><li class=""><a href="/command/query.html">buck query</a></li><li class=""><a href="/command/run.html">buck run</a></li><li class=""><a href="/command/root.html">buck root</a></li><li class=""><a href="/command/server.html">buck server</a></li><li class=""><a href="/command/targets.html">buck targets</a></li><li class=""><a href="/command/test.html">buck test</a></li><li class=""><a href="/command/uninstall.html">buck uninstall</a></li><li class=""><a href="/command/exit_codes.html">Exit Codes</a></li></ul><h3>Build Rules</h3><ul><li><strong>Core</strong></li><li class=""><a href="/rule/command_alias.html">command_alias()</a></li><li class=""><a href="/rule/export_file.html">export_file()</a></li><li class=""><a href="/rule/filegroup.html">filegroup()</a></li><li class=""><a href="/rule/genrule.html">genrule()</a></li><li class=""><a href="/rule/http_archive.html">http_archive()</a></li><li class=""><a href="/rule/http_file.html">http_file()</a></li><li class=""><a href="/rule/remote_file.html">remote_file()</a></li><li class=""><a href="/rule/test_suite.html">test_suite()</a></li><li class=""><a href="/rule/worker_tool.html">worker_tool()</a></li><li class=""><a href="/rule/zip_file.html">zip_file()</a></li><li><strong>Android</strong></li><li class=""><a href="/rule/android_aar.html">android_aar()</a></li><li class=""><a href="/rule/android_binary.html">android_binary()</a></li><li class=""><a href="/rule/android_build_config.html">android_build_config()</a></li><li class=""><a href="/rule/android_instrumentation_apk.html">android_instrumentation_apk()</a></li><li class=""><a href="/rule/android_instrumentation_test.html">android_instrumentation_test()</a></li><li class=""><a href="/rule/android_library.html">android_library()</a></li><li class=""><a href="/rule/android_manifest.html">android_manifest()</a></li><li class=""><a href="/rule/android_prebuilt_aar.html">android_prebuilt_aar()</a></li><li class=""><a href="/rule/android_resource.html">android_resource()</a></li><li class=""><a href="/rule/apk_genrule.html">apk_genrule()</a></li><li class=""><a href="/rule/gen_aidl.html">gen_aidl()</a></li><li class=""><a href="/rule/keystore.html">keystore()</a></li><li class=""><a href="/rule/ndk_library.html">ndk_library()</a></li><li class=""><a href="/rule/prebuilt_jar.html">prebuilt_jar()</a></li><li class=""><a href="/rule/prebuilt_native_library.html">prebuilt_native_library()</a></li><li class=""><a href="/rule/robolectric_test.html">robolectric_test()</a></li><li><strong>CXX</strong></li><li class=""><a href="/rule/cxx_binary.html">cxx_binary()</a></li><li class=""><a href="/rule/cxx_library.html">cxx_library()</a></li><li class=""><a href="/rule/cxx_genrule.html">cxx_genrule()</a></li><li class=""><a href="/rule/cxx_precompiled_header.html">cxx_precompiled_header()</a></li><li class=""><a href="/rule/cxx_test.html">cxx_test()</a></li><li class=""><a href="/rule/prebuilt_cxx_library.html">prebuilt_cxx_library()</a></li><li class=""><a href="/rule/prebuilt_cxx_library_group.html">prebuilt_cxx_library_group()</a></li><li><strong>D</strong></li><li class=""><a href="/rule/d_binary.html">d_binary()</a></li><li class=""><a href="/rule/d_library.html">d_library()</a></li><li class=""><a href="/rule/d_test.html">d_test()</a></li><li><strong>Go</strong></li><li class=""><a href="/rule/go_binary.html">go_binary()</a></li><li class=""><a href="/rule/go_library.html">go_library()</a></li><li class=""><a href="/rule/go_test.html">go_test()</a></li><li class=""><a href="/rule/cgo_library.html">cgo_library()</a></li><li><strong>Groovy</strong></li><li class=""><a href="/rule/groovy_library.html">groovy_library()</a></li><li><strong>Halide</strong></li><li class=""><a href="/rule/halide_library.html">halide_library()</a></li><li><strong>Haskell</strong></li><li class=""><a href="/rule/haskell_binary.html">haskell_binary()</a></li><li class=""><a href="/rule/haskell_library.html">haskell_library()</a></li><li class=""><a href="/rule/prebuilt_haskell_library.html">prebuilt_haskell_library()</a></li><li><strong>iOS</strong></li><li class=""><a href="/rule/apple_asset_catalog.html">apple_asset_catalog()</a></li><li class=""><a href="/rule/apple_binary.html">apple_binary()</a></li><li class=""><a href="/rule/apple_bundle.html">apple_bundle()</a></li><li class=""><a href="/rule/apple_library.html">apple_library()</a></li><li class=""><a href="/rule/apple_package.html">apple_package()</a></li><li class=""><a href="/rule/apple_resource.html">apple_resource()</a></li><li class=""><a href="/rule/apple_test.html">apple_test()</a></li><li class=""><a href="/rule/core_data_model.html">core_data_model()</a></li><li class=""><a href="/rule/prebuilt_apple_framework.html">prebuilt_apple_framework()</a></li><li><strong>Java</strong></li><li class=""><a href="/rule/java_binary.html">java_binary()</a></li><li class=""><a href="/rule/java_library.html">java_library()</a></li><li class=""><a href="/rule/java_test.html">java_test()</a></li><li class=""><a href="/rule/prebuilt_jar.html">prebuilt_jar()</a></li><li class=""><a href="/rule/prebuilt_native_library.html">prebuilt_native_library()</a></li><li><strong>Kotlin</strong></li><li class=""><a href="/rule/kotlin_library.html">kotlin_library()</a></li><li class=""><a href="/rule/kotlin_test.html">kotlin_test()</a></li><li><strong>Lua</strong></li><li class=""><a href="/rule/cxx_lua_extension.html">cxx_lua_extension()</a></li><li class=""><a href="/rule/lua_binary.html">lua_binary()</a></li><li class=""><a href="/rule/lua_library.html">lua_library()</a></li><li><strong>OCaml</strong></li><li class=""><a href="/rule/ocaml_binary.html">ocaml_binary()</a></li><li class=""><a href="/rule/ocaml_library.html">ocaml_library()</a></li><li><strong>Python</strong></li><li class=""><a href="/rule/prebuilt_python_library.html">prebuilt_python_library()</a></li><li class=""><a href="/rule/python_binary.html">python_binary()</a></li><li class=""><a href="/rule/python_library.html">python_library()</a></li><li class=""><a href="/rule/python_test.html">python_test()</a></li><li><strong>Rust</strong></li><li class=""><a href="/rule/rust_binary.html">rust_binary()</a></li><li class=""><a href="/rule/rust_library.html">rust_library()</a></li><li class=""><a href="/rule/rust_test.html">rust_test()</a></li><li class=""><a href="/rule/prebuilt_rust_library.html">prebuilt_rust_library()</a></li><li><strong>Shell</strong></li><li class=""><a href="/rule/sh_binary.html">sh_binary()</a></li><li class=""><a href="/rule/sh_test.html">sh_test()</a></li><li><strong>.NET</strong></li><li class=""><a href="/rule/csharp_library.html">csharp_library()</a></li><li class=""><a href="/rule/prebuilt_dotnet_library.html">prebuilt_dotnet_library()</a></li></ul><h3>Functions</h3><ul><li><strong>Python DSL</strong></li><li class=""><a href="/function/add_build_file_dep.html">add_build_file_dep()</a></li><li class=""><a href="/function/allow_unsafe_import.html">allow_unsafe_import()</a></li><li class=""><a href="/function/flatten_dicts.html">flatten_dicts()</a></li><li class=""><a href="/function/glob.html">glob()</a></li><li class=""><a href="/function/get_base_path.html">get_base_path()</a></li><li class=""><a href="/function/get_cell_name.html">get_cell_name()</a></li><li class=""><a href="/function/host_info.html">host_info()</a></li><li class=""><a href="/function/include_defs.html">include_defs()</a></li><li class=""><a href="/function/load.html">load()</a></li><li class=""><a href="/function/read_config.html">read_config()</a></li><li class=""><a href="/function/subdir_glob.html">subdir_glob()</a></li><li class=""><a href="/function/string_parameter_macros.html">String Parameter Macros</a></li></ul><ul><li><strong>Skylark</strong></li><li class=""><a href="/skylark/generated/glob.html">glob()</a></li><li class=""><a href="/skylark/generated/host_info.html">host_info()</a></li><li class=""><a href="/skylark/generated/package_name.html">package_name()</a></li><li class=""><a href="/skylark/generated/provider.html">provider()</a></li><li class=""><a href="/skylark/generated/read_config.html">read_config()</a></li><li class=""><a href="/skylark/generated/repository_name.html">repository_name()</a></li><li class=""><a href="/skylark/generated/rule_exists.html">rule_exists()</a></li></ul><h3>Extending Buck</h3><ul><li class=""><a href="/extending/macros.html">Custom Macros</a></li><li class=""><a href="/extending/rules.html">Custom Rules</a></li><li class="navActiveItem"><a href="/extending/e2e_tests.html">Building E2E Tests for Buck</a></li></ul></nav></div></section><footer><div class='width'>&copy; Copyright Facebook, 2013 - 2020</div></footer><!-- Algolia Search Code --><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
docsearch({
  apiKey: 'c25b7174e8f6161ce5fdd44bb0b95081',
  indexName: 'buckbuild',
  inputSelector: '#algolia-doc-search',
  debug: false // Set debug to true if you want to inspect the dropdown
});
</script><!-- End Algolia Search Code --><script src="/google-code-prettify/prettify.js"></script><script>prettyPrint()</script></body></html>