<!doctype html><html xmlns="http://www.w3.org/1999/xhtml"><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns#"><script>var loc = new String(window.location); if (loc.indexOf('facebook.github.io/buck') != -1) {window.location.replace(loc.replace('facebook.github.io/buck', 'buck.build'));}</script><!-- Facebook Pixel Code --><script>!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,document,'script','//connect.facebook.net/en_US/fbevents.js'); fbq('init', '1637165926500152'); fbq('track', 'PageView');</script><noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=1637165926500152&ev=PageView&noscript=1" /></noscript><!-- End Facebook Pixel Code --><title>Buck: Adding Custom Rules to Buck</title><link type="image/png" rel="shortcut icon" href="/static/favicon.png" /><meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" /><meta http-equiv="content-type" content="text/html;charset=utf-8"><link type="text/css" rel="stylesheet" href="/static/buck.css"><link type="text/css" rel="stylesheet" href="/static/search.css"><link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css" /><meta property="og:locale" content="en_US"><meta property="og:title" content="Adding Custom Rules to Buck"><meta property="og:site_name" content="Buck: a build tool"><meta property="og:image" content="http://buck.build/static/og.png"><meta property="og:type" content="article"><meta property="og:description" content="This isn&#39;t currently possible at this time unless you fork Buck. If you do fork Buck, this is how you can add new rules. Once you&#39;ve followed these steps, we&#39;d love a pull request!"><meta property="fb:admins" content="584556688222168"><script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-44373548-18', 'auto');
    ga('send', 'pageview');
  </script></head><body><div id="fb-root"></div><script>(function(d, s, id) {var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=584556688222168"; fjs.parentNode.insertBefore(js, fjs);}(document, 'script', 'facebook-jssdk'));</script><header class='topbar'><nav class='width'><a href='http://buck.build/'><h1>Buck</h1></a><ul class='menu'><li class="algolia-search-wrapper"><input id="algolia-doc-search" type="search" placeholder="Search docs..." /></li><li><a href='/setup/getting_started.html'>Docs</a><li><a href='https://github.com/facebook/buck/issues'>Issues</a><li><a href='https://github.com/facebook/buck'>GitHub</a></ul></nav></header><section class='content'><div class='width'><article id="content"><h1>Adding Custom Rules to Buck</h1><div class="overview">As of the writing of this document, the only official way to add rules to Buck is to fork the project and modify the source. We will, at some point, construct a beautiful and elegant extensions API. Until then, you'll want to have the documentation of our internal <a href='/javadoc/'>API</a> handy, and then...<p>Start by editing <code>KnownBuildRuleTypes</code>. You'll need to edit <code>createBuilder()</code> and find the block where there are a large number of calls to <code>builder.register()</code>.<pre class="prettyprint lang-java">builder.register(new YourDescription());</pre>What is <code>YourDescription</code>? It's an implementation of the <a href="https://buck.build/javadoc/com/facebook/buck/core/description/Description.html"><code>Description</code></a> interface. This interface serves three roles in Buck:<ol><li>It provides the name for the rule type, eg. <code>java_library</code></li><li>It makes clear the parameters which are accepted by a rule</li><li>It acts as a factory of <a href="https://buck.build/javadoc/com/facebook/buck/rules/BuildRule.html"><code>BuildRule</code></a> instances.</li></ol><h3>Defining Rule Parameters</h3>This is done by implementing <code>Description.createUnpopulatedConstructorArg()</code>. This should return a java object, the public fields of which are the camelCased names of the parameters used by the rule in BUCK files. When referenced in BUCK files, the field name is snake_cased. That is "someParam" would become "some_param".<p>You may use primitives, enums, generic types, collections (including generic collections), and custom types for the fields of the constructor arg. If you are using a custom type which Buck does not know how to marshal from JSON, then you must implement a <a href="https://buck.build/javadoc/com/facebook/buck/rules/coercer/TypeCoercer.html"><code>TypeCoercer</code></a>. How to do this is beyond the scope of this doc.<p>Note: if a parameter might either be a local file or an output of a <code>BuildRule</code>, then you can use a <a href="https://buck.build/javadoc/com/facebook/buck/rules/SourcePath.html"><code>SourcePath</code></a>to represent that parameter.<p>If a parmater is considered to be optional, then the field should be declared using Guava's <code>Optional</code> class (eg. <code>public Optional&lt;String> name;</code>)<h3>Constructing new BuildRule instances</h3>When Buck needs to construct a <code>BuildRule</code> it will call <code>Description.createBuildRule()</code>, passing in a populated constructor arg. Collection types on that arg will have been instantiated with an empty collection, even if they are declared as being optional.<p>The <code>createBuildRule</code> method is responsible for returning an instantiated <code>BuildRule</code> that can be used to construct whatever it is that we're adding this build rule for. The current instances typically inherit from <a href="https://buck.build/javadoc/com/facebook/buck/rules/AbstractBuildRule.html"><code>AbstractBuildRule</code></a>, and we suggest you do so too.<p>The created <code>BuildRule</code> will be registered with the <code>BuildRuleResolver</code> automatically. There are, however, plenty of cases where a <code>BuildRule</code> will want to depend on existing functionality that's already expressed as a <code>BuildRule</code>. In this case, it's fine to create that intermediate rule in the <code>createBuildRule()</code> method, add it to the resolver, and then add that newly created rule as a dependency of the one ultimately returned from the method. The only caveat: each rule must have its own, unique, <code>BuildTarget</code>, which is the name by which it's referred to in the action graph.<p>You are strongly encouraged to delay doing any work in your <code>BuildRule</code> until the <code>getBuildSteps()</code> method. In particular, don't do any work other than assigning fields in the constructor! The exception to this is working out the path to the output of your rule.<p>You can think of a <code>Description</code> as a factory of <code>BuildRule</code> instances. Similarly, you can think of a <code>BuildRule</code> as a factory of <a href="https://buck.build/javadoc/com/facebook/buck/step/Step.html"><code>Step</code>s</a> that must be executed in order to create a specific output. Unlike rules, steps are executed sequentially in the order in which they are returned.<h3>Ensuring Your Rule Is Rebuilt Correctly</h3>If your rule extends <code>AbstractBuildRule</code>, then it's enough to simply annotate any field on that rule that contributes to its uniqueness with <a href="https://buck.build/javadoc/com/facebook/buck/rules/AddToRuleKey.html"><code>@AddToRuleKey</code></a>. This is used by Buck to calculate the rule key, which, if the value changes between builds, will cause Buck to re-execute your <code>BuildRule</code>.<p>Another tip for ensuring your rule rebuilds correctly between builds is to ensure that the output directory is cleaned each time. Commonly, you'll see the first steps of a rule are something like:<pre class="prettyprint lang-java">Path outputDir = BuildTargets.getGenPath(target, "%s-output"); steps.add(new MakeCleanDirectoryStep(outputDir));</pre>In your IDE, take a look at the key interfaces and classes to discover more about what you can do within Buck:<ul><li><a href="https://buck.build/javadoc/com/facebook/buck/rules/Description.html"><code>Description</code></a></li><li><a href="https://buck.build/javadoc/com/facebook/buck/rules/AbstractBuildRule.html"><code>AbstractBuildRule</code></a></li><li><a href="https://buck.build/javadoc/com/facebook/buck/step/Step.html"><code>Step</code></a></li></ul></div></article><nav><h3>The Basics</h3><ul><li class=""><a href="/setup/getting_started.html">Getting Started</a></li><li class=""><a href="/about/overview.html">Key Concepts</a></li><li class=""><a href="/learning/tutorial.html">Tutorial</a></li><li class=""><a href="/setup/intellij_plugin_install.html">Installing the IntelliJ Plugin</a></li><li class=""><a href="/article/exopackage.html">Exopackage</a></li><li class=""><a href="/article/query_cheat_sheet.html">Buck Cheat Sheet</a></li></ul><h3>About</h3><ul><li class=""><a href="/concept/what_makes_buck_so_fast.html">What Makes Buck so Fast?</a></li><li class=""><a href="/about/showcase.html">Showcase</a></li><li class=""><a href="/concept/troubleshooting.html">Troubleshooting</a></li><li class=""><a href="/about/performance_tuning.html">Performance Tuning</a></li><li class=""><a href="/concept/faq.html">FAQ</a></li><li class=""><a href="/presentations/index.html">Learn More (Buck Presentations)</a></li></ul><h3>Concepts</h3><ul><li class=""><a href="/concept/build_rule.html">Build Rule</a></li><li class=""><a href="/concept/build_file.html">Build File</a></li><li class=""><a href="/concept/build_target.html">Build Target</a></li><li class=""><a href="/concept/build_target_pattern.html">Build Target Pattern</a></li><li class=""><a href="/concept/buckd.html">Buck Daemon (buckd)</a></li><li class=""><a href="/concept/visibility.html">Visibility</a></li><li class=""><a href="/concept/flavors.html">Flavors</a></li><li class=""><a href="/concept/http_cache_api.html">HTTP Cache API</a></li><li class=""><a href="/concept/rule_keys.html">Rule Keys</a></li><li class=""><a href="/concept/java_abis.html">Java ABIs</a></li><li class=""><a href="/concept/skylark.html">Skylark</a></li></ul><h3>Files and Directories</h3><ul><li class=""><a href="/files-and-dirs/buckconfig.html">.buckconfig</a></li><li class=""><a href="/files-and-dirs/buckjavaargs.html">.buckjavaargs</a></li><li class=""><a href="/files-and-dirs/buck-out.html">buck-out</a></li></ul><h3>Commands</h3><ul><li class=""><a href="/command/common_parameters.html">Common Parameters</a></li><li class=""><a href="/command/audit.html">buck audit</a></li><li class=""><a href="/command/build.html">buck build</a></li><li class=""><a href="/command/clean.html">buck clean</a></li><li class=""><a href="/command/doctor.html">buck doctor</a></li><li class=""><a href="/command/fetch.html">buck fetch</a></li><li class=""><a href="/command/fix.html">buck fix</a></li><li class=""><a href="/command/install.html">buck install</a></li><li class=""><a href="/command/kill.html">buck kill</a></li><li class=""><a href="/command/killall.html">buck killall</a></li><li class=""><a href="/command/project.html">buck project</a></li><li class=""><a href="/command/publish.html">buck publish</a></li><li class=""><a href="/command/query.html">buck query</a></li><li class=""><a href="/command/run.html">buck run</a></li><li class=""><a href="/command/root.html">buck root</a></li><li class=""><a href="/command/server.html">buck server</a></li><li class=""><a href="/command/targets.html">buck targets</a></li><li class=""><a href="/command/test.html">buck test</a></li><li class=""><a href="/command/uninstall.html">buck uninstall</a></li><li class=""><a href="/command/exit_codes.html">Exit Codes</a></li></ul><h3>Build Rules</h3><ul><li><strong>Core</strong></li><li class=""><a href="/rule/command_alias.html">command_alias()</a></li><li class=""><a href="/rule/export_file.html">export_file()</a></li><li class=""><a href="/rule/filegroup.html">filegroup()</a></li><li class=""><a href="/rule/genrule.html">genrule()</a></li><li class=""><a href="/rule/http_archive.html">http_archive()</a></li><li class=""><a href="/rule/http_file.html">http_file()</a></li><li class=""><a href="/rule/remote_file.html">remote_file()</a></li><li class=""><a href="/rule/test_suite.html">test_suite()</a></li><li class=""><a href="/rule/worker_tool.html">worker_tool()</a></li><li class=""><a href="/rule/zip_file.html">zip_file()</a></li><li><strong>Android</strong></li><li class=""><a href="/rule/android_aar.html">android_aar()</a></li><li class=""><a href="/rule/android_binary.html">android_binary()</a></li><li class=""><a href="/rule/android_build_config.html">android_build_config()</a></li><li class=""><a href="/rule/android_instrumentation_apk.html">android_instrumentation_apk()</a></li><li class=""><a href="/rule/android_instrumentation_test.html">android_instrumentation_test()</a></li><li class=""><a href="/rule/android_library.html">android_library()</a></li><li class=""><a href="/rule/android_manifest.html">android_manifest()</a></li><li class=""><a href="/rule/android_prebuilt_aar.html">android_prebuilt_aar()</a></li><li class=""><a href="/rule/android_resource.html">android_resource()</a></li><li class=""><a href="/rule/apk_genrule.html">apk_genrule()</a></li><li class=""><a href="/rule/gen_aidl.html">gen_aidl()</a></li><li class=""><a href="/rule/keystore.html">keystore()</a></li><li class=""><a href="/rule/ndk_library.html">ndk_library()</a></li><li class=""><a href="/rule/prebuilt_jar.html">prebuilt_jar()</a></li><li class=""><a href="/rule/prebuilt_native_library.html">prebuilt_native_library()</a></li><li class=""><a href="/rule/robolectric_test.html">robolectric_test()</a></li><li><strong>CXX</strong></li><li class=""><a href="/rule/cxx_binary.html">cxx_binary()</a></li><li class=""><a href="/rule/cxx_library.html">cxx_library()</a></li><li class=""><a href="/rule/cxx_genrule.html">cxx_genrule()</a></li><li class=""><a href="/rule/cxx_precompiled_header.html">cxx_precompiled_header()</a></li><li class=""><a href="/rule/cxx_test.html">cxx_test()</a></li><li class=""><a href="/rule/prebuilt_cxx_library.html">prebuilt_cxx_library()</a></li><li class=""><a href="/rule/prebuilt_cxx_library_group.html">prebuilt_cxx_library_group()</a></li><li><strong>D</strong></li><li class=""><a href="/rule/d_binary.html">d_binary()</a></li><li class=""><a href="/rule/d_library.html">d_library()</a></li><li class=""><a href="/rule/d_test.html">d_test()</a></li><li><strong>Go</strong></li><li class=""><a href="/rule/go_binary.html">go_binary()</a></li><li class=""><a href="/rule/go_library.html">go_library()</a></li><li class=""><a href="/rule/go_test.html">go_test()</a></li><li class=""><a href="/rule/cgo_library.html">cgo_library()</a></li><li><strong>Groovy</strong></li><li class=""><a href="/rule/groovy_library.html">groovy_library()</a></li><li><strong>Halide</strong></li><li class=""><a href="/rule/halide_library.html">halide_library()</a></li><li><strong>Haskell</strong></li><li class=""><a href="/rule/haskell_binary.html">haskell_binary()</a></li><li class=""><a href="/rule/haskell_library.html">haskell_library()</a></li><li class=""><a href="/rule/prebuilt_haskell_library.html">prebuilt_haskell_library()</a></li><li><strong>iOS</strong></li><li class=""><a href="/rule/apple_asset_catalog.html">apple_asset_catalog()</a></li><li class=""><a href="/rule/apple_binary.html">apple_binary()</a></li><li class=""><a href="/rule/apple_bundle.html">apple_bundle()</a></li><li class=""><a href="/rule/apple_library.html">apple_library()</a></li><li class=""><a href="/rule/apple_package.html">apple_package()</a></li><li class=""><a href="/rule/apple_resource.html">apple_resource()</a></li><li class=""><a href="/rule/apple_test.html">apple_test()</a></li><li class=""><a href="/rule/core_data_model.html">core_data_model()</a></li><li class=""><a href="/rule/prebuilt_apple_framework.html">prebuilt_apple_framework()</a></li><li><strong>Java</strong></li><li class=""><a href="/rule/java_binary.html">java_binary()</a></li><li class=""><a href="/rule/java_library.html">java_library()</a></li><li class=""><a href="/rule/java_test.html">java_test()</a></li><li class=""><a href="/rule/prebuilt_jar.html">prebuilt_jar()</a></li><li class=""><a href="/rule/prebuilt_native_library.html">prebuilt_native_library()</a></li><li><strong>Kotlin</strong></li><li class=""><a href="/rule/kotlin_library.html">kotlin_library()</a></li><li class=""><a href="/rule/kotlin_test.html">kotlin_test()</a></li><li><strong>Lua</strong></li><li class=""><a href="/rule/cxx_lua_extension.html">cxx_lua_extension()</a></li><li class=""><a href="/rule/lua_binary.html">lua_binary()</a></li><li class=""><a href="/rule/lua_library.html">lua_library()</a></li><li><strong>OCaml</strong></li><li class=""><a href="/rule/ocaml_binary.html">ocaml_binary()</a></li><li class=""><a href="/rule/ocaml_library.html">ocaml_library()</a></li><li><strong>Python</strong></li><li class=""><a href="/rule/prebuilt_python_library.html">prebuilt_python_library()</a></li><li class=""><a href="/rule/python_binary.html">python_binary()</a></li><li class=""><a href="/rule/python_library.html">python_library()</a></li><li class=""><a href="/rule/python_test.html">python_test()</a></li><li><strong>Rust</strong></li><li class=""><a href="/rule/rust_binary.html">rust_binary()</a></li><li class=""><a href="/rule/rust_library.html">rust_library()</a></li><li class=""><a href="/rule/rust_test.html">rust_test()</a></li><li class=""><a href="/rule/prebuilt_rust_library.html">prebuilt_rust_library()</a></li><li><strong>Shell</strong></li><li class=""><a href="/rule/sh_binary.html">sh_binary()</a></li><li class=""><a href="/rule/sh_test.html">sh_test()</a></li><li><strong>.NET</strong></li><li class=""><a href="/rule/csharp_library.html">csharp_library()</a></li><li class=""><a href="/rule/prebuilt_dotnet_library.html">prebuilt_dotnet_library()</a></li></ul><h3>Functions</h3><ul><li><strong>Python DSL</strong></li><li class=""><a href="/function/add_build_file_dep.html">add_build_file_dep()</a></li><li class=""><a href="/function/allow_unsafe_import.html">allow_unsafe_import()</a></li><li class=""><a href="/function/flatten_dicts.html">flatten_dicts()</a></li><li class=""><a href="/function/glob.html">glob()</a></li><li class=""><a href="/function/get_base_path.html">get_base_path()</a></li><li class=""><a href="/function/get_cell_name.html">get_cell_name()</a></li><li class=""><a href="/function/host_info.html">host_info()</a></li><li class=""><a href="/function/include_defs.html">include_defs()</a></li><li class=""><a href="/function/load.html">load()</a></li><li class=""><a href="/function/read_config.html">read_config()</a></li><li class=""><a href="/function/subdir_glob.html">subdir_glob()</a></li><li class=""><a href="/function/string_parameter_macros.html">String Parameter Macros</a></li></ul><ul><li><strong>Skylark</strong></li><li class=""><a href="/skylark/generated/glob.html">glob()</a></li><li class=""><a href="/skylark/generated/host_info.html">host_info()</a></li><li class=""><a href="/skylark/generated/package_name.html">package_name()</a></li><li class=""><a href="/skylark/generated/provider.html">provider()</a></li><li class=""><a href="/skylark/generated/read_config.html">read_config()</a></li><li class=""><a href="/skylark/generated/repository_name.html">repository_name()</a></li><li class=""><a href="/skylark/generated/rule_exists.html">rule_exists()</a></li></ul><h3>Extending Buck</h3><ul><li class=""><a href="/extending/macros.html">Custom Macros</a></li><li class="navActiveItem"><a href="/extending/rules.html">Custom Rules</a></li><li class=""><a href="/extending/e2e_tests.html">Building E2E Tests for Buck</a></li></ul></nav></div></section><footer><div class='width'>&copy; Copyright Facebook, 2013 - 2020</div></footer><!-- Algolia Search Code --><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
docsearch({
  apiKey: 'c25b7174e8f6161ce5fdd44bb0b95081',
  indexName: 'buckbuild',
  inputSelector: '#algolia-doc-search',
  debug: false // Set debug to true if you want to inspect the dropdown
});
</script><!-- End Algolia Search Code --></body></html>